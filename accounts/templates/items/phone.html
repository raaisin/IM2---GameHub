<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/items/phone.css' %}">
    <title>Phones</title>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">Phone Store</div>
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="Search for phones...">
                <button class="search-button">üîç</button>
            </div>
            <nav class="nav-links">
                <a href="{% url 'home' %}" class="nav-link">Home</a>
                <a href="#" class="nav-link">Categories</a>
                <a href="{% url 'carts' %}" class="nav-link cart-icon">üõí</a>
            </nav>
        </div>
    </header>

    <div class="product-section">
        {% for phone in phones %}
        <div class="product-item">
            <img src="{% if phone.image %}{{ phone.image.url }}{% else %}{% static 'images/placeholder.jpg' %}{% endif %}" alt="{{ phone.name }}">
            <div class="product-title">{{ phone.name }}</div>
            <div class="product-rating">
                {% with rating=phone.rating|floatformat:0 %}
                    {% for i in "12345" %}
                        {% if forloop.counter <= rating %}‚òÖ{% else %}‚òÜ{% endif %}
                    {% endfor %}
                {% endwith %}
                ({{ phone.rating }})
            </div>
            <div class="product-sold">{{ phone.sold }} sold</div>
            <div class="product-price">‚Ç±{{ phone.price|floatformat:2 }}</div>
            <div class="product-options">
                <label class="option-label">Color:</label>
                <select class="product-color">
                    {% for color in phone.colors %}
                    <option>{{ color }}</option>
                    {% endfor %}
                </select>
                <label class="option-label">Quantity:</label>
                <div class="quantity-controls">
                    <button class="decrease" onclick="changeQuantity(this, -1)">-</button>
                    <input type="number" class="quantity-input" value="1" min="1" max="5" readonly>
                    <button class="increase" onclick="changeQuantity(this, 1)">+</button>
                </div>
            </div>
            <button class="add-to-cart" data-product-id="{{ phone.id }}">Add to Cart</button>
        </div>
        {% endfor %}
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize cart in localStorage if it doesn't exist
        if (!localStorage.getItem('cartItems')) {
            localStorage.setItem('cartItems', JSON.stringify([]));
        }

        // Cart Management
        const addToCartButtons = document.querySelectorAll('.add-to-cart');
        const checkoutButton = document.querySelector('.checkout-button');

        // Function to change quantity
        function changeQuantity(button, change) {
            const quantityInput = button.parentElement.querySelector('.quantity-input');
            let currentValue = parseInt(quantityInput.value);
            let newValue = currentValue + change;
            
            // Ensure value stays within min and max
            newValue = Math.max(1, Math.min(newValue, 5));
            quantityInput.value = newValue;
        }

        // Attach changeQuantity to global scope
        window.changeQuantity = changeQuantity;

        addToCartButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Find the closest product item
                const productItem = this.closest('.product-item');
                
                // Extract product details
                const priceText = productItem.querySelector('.product-price').textContent;
                const price = parseFloat(priceText.replace('‚Ç±', '').replace(',', '').trim());

                const product = {
                    id: this.getAttribute('data-product-id'),  // Use data-product-id
                    name: productItem.querySelector('.product-title').textContent,
                    price: price,
                    image: productItem.querySelector('img').src,
                    color: productItem.querySelector('.product-color').value,
                    quantity: parseInt(productItem.querySelector('.quantity-input').value)
                };

                // Retrieve existing cart items
                let cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');

                // Check if product already exists in cart
                const existingProductIndex = cartItems.findIndex(item => 
                    item.id === product.id && 
                    item.color === product.color
                );

                if (existingProductIndex !== -1) {
                    // Update quantity if product exists
                    cartItems[existingProductIndex].quantity += product.quantity;
                } else {
                    // Add new product to cart
                    cartItems.push(product);
                }

                // Save updated cart
                localStorage.setItem('cartItems', JSON.stringify(cartItems));

                // Update button UI
                this.textContent = 'Added to Cart';
                this.style.backgroundColor = '#4CAF50';
                this.style.color = 'white';
                this.disabled = true;

                // Optional: Show cart count
                updateCartCount();
            });
        });

        // Function to update cart count
        function updateCartCount() {
            const cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
            const cartIcon = document.querySelector('.cart-icon');
            if (cartIcon) {
                const totalQuantity = cartItems.reduce((total, item) => total + item.quantity, 0);
                cartIcon.textContent = `üõí (${totalQuantity})`;
            }
        }

        // Initialize cart count on page load
        updateCartCount();
    });
    </script>
</body>
</html>