<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Shopping Cart</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            background-color: #f4f4f4;
            padding: 20px;
        }
        .cart-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f1f1f1;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .cart-items {
            display: grid;
            gap: 15px;
        }
        .cart-item {
            display: flex;
            align-items: center;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        .cart-item img {
            width: 120px;
            height: 120px;
            object-fit: cover;
        }
        .item-details {
            flex-grow: 1;
            padding: 15px;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .quantity-control button {
            width: 30px;
            height: 30px;
            background-color: #f1f1f1;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .quantity-control input {
            width: 50px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
        }
        .cart-summary {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #f1f1f1;
            text-align: right;
        }
        .checkout-btn, .continue-shopping-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-block;
            margin-top: 10px;
        }
        .checkout-btn:hover, .continue-shopping-btn:hover {
            background-color: #45a049;
        }
        .cart-empty {
            text-align: center;
            padding: 20px;
            color: #888;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #order-confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #order-confirmation-modal .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        #order-confirmation-modal .modal-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        #order-confirmation-modal .modal-actions button {
            flex-grow: 1;
            margin: 0 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #order-confirmation-modal .modal-actions .view-order-btn {
            background-color: #4CAF50;
            color: white;
        }
        #order-confirmation-modal .modal-actions .continue-shopping-btn {
            background-color: #2196F3;
            color: white;
        }
    </style>
</head>
<body>
    <div class="cart-container">
        <div class="cart-header">
            <h1>Your Shopping Cart</h1>
            <div class="cart-count">0 items</div>
        </div>
        
        <div id="cart-items" class="cart-items">
            weqwe
            {% for items in cart_items %}
            <div class="cart-item">
                <img src="http://127.0.0.1:8000/media/{{items.product.image}}" alt="Huawei MateBook">
                <div class="item-details">
                    <h3>{{items.product.name}}</h3>
                    <p>Price: ${{items.product.price}}</p>
                    <p>Color:{{items.color}}</p>
                    <div class="quantity-control">
                        <button onclick="cartManager.updateQuantity('3', '{'color': 'Space Gray'}', 0)">-</button>
                        <input type="number" value="1" min="1" readonly="">
                        <button onclick="cartManager.updateQuantity('3', '{'color': 'Space Gray'}', 2)">+</button>
                        <button style="background-color: #ff4444; color: white; margin-left: 10px;" onclick="cartManager.updateQuantity('3', '{'color': 'Space Gray'}', 0)">
                            Remove
                        </button>
                    </div>
                    <p>Item Total: $899.99</p>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="cart-summary">
            <div class="summary-details">
                <p>Subtotal: <span id="subtotal">$0.00</span></p>
                <p>Tax (8%): <span id="tax">$0.00</span></p>
                <p><strong>Total: <span id="total">$0.00</span></strong></p>
            </div>
            <button class="checkout-btn">Proceed to Checkout</button>
        </div>
    </div>
    <script>
        class StorageManager {
        constructor() {
            this._storage = {};
            this._localStorageAvailable = this._checkLocalStorageAvailability();
        }

        _checkLocalStorageAvailability() {
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                return true;
            } catch(e) {
                return false;
            }
        }

        getItem(key) {
            if (this._localStorageAvailable) {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : null;
                } catch (e) {
                    console.error('Error parsing localStorage item:', e);
                    return null;
                }
            }
            
            // Fallback to in-memory storage
            return this._storage[key] ? JSON.parse(this._storage[key]) : null;
        }

        setItem(key, value) {
            if (this._localStorageAvailable) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error('Error setting localStorage item:', e);
                }
            }
            
            // Fallback to in-memory storage
            this._storage[key] = JSON.stringify(value);
            return false;
        }

        removeItem(key) {
            if (this._localStorageAvailable) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.error('Error removing localStorage item:', e);
                }
            }
            
            // Fallback to in-memory storage
            delete this._storage[key];
            return false;
        }
    }

    class CartManager {
        constructor() {
            this.TAX_RATE = 0.08;
            this.storageManager = new StorageManager();
            this.cartItems = this.storageManager.getItem('cartItems') || [];
            this.cartContainer = document.getElementById('cart-items');
            this.subtotalElement = document.getElementById('subtotal');
            this.taxElement = document.getElementById('tax');
            this.totalElement = document.getElementById('total');
            this.cartCountElement = document.querySelector('.cart-count');
            
            this.initializeEventListeners();
            this.renderCart();
        }

        initializeEventListeners() {
            const checkoutBtn = document.querySelector('.checkout-btn');
            checkoutBtn.addEventListener('click', () => this.processCheckout());
        }

        
        updateQuantity(id, color, quantity) {
            const itemIndex = this.cartItems.findIndex(
                item => item.id === id && item.color === color
            );

            if (itemIndex > -1) {
                if (quantity > 0) {
                    this.cartItems[itemIndex].quantity = quantity;
                } else {
                    this.cartItems.splice(itemIndex, 1);
                }
                this.saveCart();
                this.renderCart();
            }
        }

        saveCart() {
            this.storageManager.setItem('cartItems', this.cartItems);
        }

        renderCart() {
            this.cartContainer.innerHTML = '';
            
            if (this.cartItems.length === 0) {
                this.cartContainer.innerHTML = `
                    <div class="cart-empty">
                        <p>Your cart is empty</p>
                        <a href="{% url 'home' %}" class="continue-shopping-btn">Continue Shopping</a>
                    </div>
                `;
            }

            let subtotal = 0;

            this.cartItems.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;

                const cartItemElement = document.createElement('div');
                cartItemElement.classList.add('cart-item');
                cartItemElement.innerHTML = `
                    <img src="${item.image}" alt="${item.name}">
                    <div class="item-details">
                        <h3>${item.name}</h3>
                        <p>Price: $${item.price.toFixed(2)}</p>
                        <p>Color: ${item.color}</p>
                        <div class="quantity-control">
                            <button onclick="cartManager.updateQuantity('${item.id}', '${item.color}', ${item.quantity - 1})">-</button>
                            <input type="number" value="${item.quantity}" min="1" readonly>
                            <button onclick="cartManager.updateQuantity('${item.id}', '${item.color}', ${item.quantity + 1})">+</button>
                            <button style="background-color: #ff4444; color: white; margin-left: 10px;" 
                                    onclick="cartManager.updateQuantity('${item.id}', '${item.color}', 0)">
                                Remove
                            </button>
                        </div>
                        <p>Item Total: $${itemTotal.toFixed(2)}</p>
                    </div>
                `;

                this.cartContainer.appendChild(cartItemElement);
            });

            const tax = subtotal * this.TAX_RATE;
            const total = subtotal + tax;

            this.subtotalElement.textContent = `$${subtotal.toFixed(2)}`;
            this.taxElement.textContent = `$${tax.toFixed(2)}`;
            this.totalElement.textContent = `$${total.toFixed(2)}`;
            this.cartCountElement.textContent = `${this.cartItems.length} items`;
        }

        processCheckout() {
            if (this.cartItems.length === 0) {
                alert('Your cart is empty!');
                return;
            }

            const order = {
                id: Date.now(),
                items: this.cartItems,
                subtotal: parseFloat(this.subtotalElement.textContent.replace('$', '')),
                tax: parseFloat(this.taxElement.textContent.replace('$', '')),
                total: parseFloat(this.totalElement.textContent.replace('$', '')),
                date: new Date().toISOString(),
                status: 'pending',
                trackingNumber: `ORD-${Math.random().toString(36).substr(2, 9).toUpperCase()}`
            };

            // Store order
            const orders = this.storageManager.getItem('orders') || [];
            orders.push(order);
            this.storageManager.setItem('orders', orders);

            // Clear cart
            this.storageManager.removeItem('cartItems');
            this.cartItems = [];
            this.renderCart();

            // Create custom confirmation modal
            this.showOrderConfirmationModal(order);
        }

        showOrderConfirmationModal(order) {
            // Remove any existing modal
            const existingModal = document.getElementById('order-confirmation-modal');
            if (existingModal) {
                document.body.removeChild(existingModal);
            }

            // Create modal element
            const modalDiv = document.createElement('div');
            modalDiv.id = 'order-confirmation-modal';
            modalDiv.innerHTML = `
                <div class="modal-content">
                    <h2>Order Placed Successfully!</h2>
                    <p>Tracking Number: ${order.trackingNumber}</p>
                    <p>Total: $${order.total.toFixed(2)}</p>
                    <div class="modal-actions">
                        <button class="view-order-btn">View Orders</button>
                        <button class="continue-shopping-btn">Continue Shopping</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modalDiv);

            const viewOrderBtn = modalDiv.querySelector('.view-order-btn');
            const continueShoppingBtn = modalDiv.querySelector('.continue-shopping-btn');

            viewOrderBtn.addEventListener('click', () => {
                window.location.href = "{% url 'orders' %}";
            });


            continueShoppingBtn.addEventListener('click', () => {
                // Remove modal
                document.body.removeChild(modalDiv);
                // Redirect to home or product page (replace with your actual home page URL)
                window.location.href = "{% url 'home' %}";
            });
        }
    }

    // Initialize cart manager
    const cartManager = new CartManager();

    // Simulate adding products (you'd typically do this from product pages)
    window.demoAddToCart = function() {
        const demoProduct = {
            id: 'laptop-001',
            name: 'Gaming Laptop',
            price: 1299.99,
            image: 'https://via.placeholder.com/150',
            color: 'Black',
            quantity: 1
        };
        cartManager.addToCart(demoProduct);
    }

    // Placeholder function for navigating to product page
    window.goToProductPage = function() {
        alert('Navigate to product page (implement your own navigation logic)');
    }
    
    </script>
</body>
</html>