<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Shopping Cart</title>
    <link rel="stylesheet" href="{% static 'css/cart.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <a href="{% url 'home' %}" class="back-to-home">
            ← Back to Shop
        </a>
        <h1>Your Shopping Cart</h1>
    </header>

    <div class="cart-container">
        <div id="cart-items">
            <!-- Cart items will be dynamically inserted here -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const cartContainer = document.querySelector('.cart-container');
            const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
            const taxRate = 0.08;

            if (cartItems.length === 0) {
                cartContainer.innerHTML = `
                    <div class="empty-cart">
                        <h2>Your cart is empty</h2>
                        <a href="{% url 'home' %}" class="continue-shopping">Continue Shopping</a>
                    </div>
                `;
                return;
            }

            // Clear existing cart items
            cartContainer.innerHTML = '';

            // Render cart items
            cartItems.forEach(item => {
                const cartItemDiv = document.createElement('div');
                cartItemDiv.className = 'cart-item';
                cartItemDiv.innerHTML = `
                    <img src="${item.image}" alt="${item.name}">
                    <div class="item-info">
                        <div>
                            <p class="item-name">${item.name}</p>
                            <p class="item-specs">Color: ${item.color}</p>
                            <p class="item-specs">${item.specification.name}: ${item.specification.value}</p>
                            <p class="item-price" data-price="${item.price}">$${(item.price * item.quantity).toFixed(2)}</p>
                        </div>
                        <div class="quantity-control">
                            <button class="decrease">−</button>
                            <span class="quantity-display">${item.quantity}</span>
                            <button class="increase">+</button>
                        </div>
                    </div>
                    <button class="remove-item">Remove</button>
                `;
                cartContainer.appendChild(cartItemDiv);
            });

            // Add cart summary
            const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * taxRate;
            const total = subtotal + tax;

            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'cart-summary';
            summaryDiv.innerHTML = `
                <div class="summary-row">
                    <p class="summary-text">Subtotal:</p>
                    <p class="summary-text">$${subtotal.toFixed(2)}</p>
                </div>
                <div class="summary-row">
                    <p class="summary-text">Tax (8%):</p>
                    <p class="summary-text">$${tax.toFixed(2)}</p>
                </div>
                <div class="summary-row">
                    <p class="summary-total">Total:</p>
                    <p class="summary-total">$${total.toFixed(2)}</p>
                </div>
                <button class="checkout-btn">Proceed to Checkout</button>
            `;
            cartContainer.appendChild(summaryDiv);

            // Handle quantity controls and remove buttons
            cartContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('decrease') || 
                    e.target.classList.contains('increase') || 
                    e.target.classList.contains('remove-item')) {
                    
                    const cartItem = e.target.closest('.cart-item');
                    const itemName = cartItem.querySelector('.item-name').textContent;
                    const cartItems = JSON.parse(localStorage.getItem('cartItems'));
                    const itemIndex = cartItems.findIndex(item => item.name === itemName);

                    if (e.target.classList.contains('remove-item')) {
                        cartItems.splice(itemIndex, 1);
                        cartItem.style.transform = 'translateX(-100%)';
                        cartItem.style.opacity = '0';
                        setTimeout(() => {
                            cartItem.remove();
                            if (cartItems.length === 0) {
                                location.href = "{% url 'home' %}";
                            }
                        }, 300);
                    } else {
                        const quantityDisplay = cartItem.querySelector('.quantity-display');
                        let quantity = parseInt(quantityDisplay.textContent);

                        if (e.target.classList.contains('decrease') && quantity > 1) {
                            quantity--;
                        } else if (e.target.classList.contains('increase')) {
                            quantity++;
                        }

                        quantityDisplay.textContent = quantity;
                        cartItems[itemIndex].quantity = quantity;
                        
                        // Update price display
                        const priceElement = cartItem.querySelector('.item-price');
                        const unitPrice = parseFloat(priceElement.dataset.price);
                        priceElement.textContent = `$${(unitPrice * quantity).toFixed(2)}`;
                    }

                    localStorage.setItem('cartItems', JSON.stringify(cartItems));
                    updateCartTotals();
                }
            });

            // Add checkout button handler
            const checkoutBtn = document.querySelector('.checkout-btn');
            checkoutBtn.addEventListener('click', function() {
                // Prepare the order data
                const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
                const orderDate = new Date().toISOString();
                const orderId = Date.now(); // Simple unique ID based on the current timestamp
                const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const tax = subtotal * taxRate;
                const total = subtotal + tax;

                const order = {
                    orderId: orderId,
                    orderDate: orderDate,
                    items: cartItems,
                    total: total,
                };

                // Save the order to local storage
                let orders = JSON.parse(localStorage.getItem('orderHistory')) || [];
                orders.push(order);
                localStorage.setItem('orderHistory', JSON.stringify(orders));

                // Clear the cart
                localStorage.removeItem('cartItems');

                // Redirect to orders page
                location.href = "{% url 'orders' %}";
            });

            function updateCartTotals() {
                const cartItems = JSON.parse(localStorage.getItem('cartItems'));
                const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const tax = subtotal * taxRate;
                const total = subtotal + tax;

                const summary = document.querySelector('.cart-summary');
                summary.querySelector('.summary-text:nth-child(2)').textContent = `$${subtotal.toFixed(2)}`;
                summary.querySelector('.summary-text:nth-child(4)').textContent = `$${tax.toFixed(2)}`;
                summary.querySelector('.summary-total:nth-child(2)').textContent = `$${total.toFixed(2)}`;
            }
        });
    </script>
</body>
</html>
